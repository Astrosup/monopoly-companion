<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monopoly Companion OS</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --p-red: #ff5252;
            --p-blue: #448aff;
            --p-green: #69f0ae;
            --p-yellow: #ffd740;
            --accent: #7c4dff;
            --danger: #ff4081;
            --success: #00e676;
            
            /* Board Colors */
            --c-brown: #8d6e63;
            --c-light-blue: #81d4fa;
            --c-pink: #f48fb1;
            --c-orange: #ffcc80;
            --c-red: #ef5350;
            --c-yellow: #fff59d;
            --c-green: #a5d6a7;
            --c-blue: #90caf9;
            --c-rail: #bdbdbd;
            --c-util: #ffe082;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden; /* App feel */
            height: 100vh;
            width: 100vw;
        }

        /* Layout Utilities */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            background: var(--bg-dark);
            z-index: 10;
        }
        .hidden { display: none !important; }
        .scroll-y { overflow-y: auto; flex: 1; padding: 10px; -webkit-overflow-scrolling: touch; }
        .row { display: flex; gap: 10px; align-items: center; }
        .col { display: flex; flex-direction: column; gap: 10px; }
        .center { display: flex; justify-content: center; align-items: center; }
        .between { justify-content: space-between; }
        
        /* Typography */
        h1, h2, h3 { margin: 0; }
        .text-lg { font-size: 1.25rem; font-weight: bold; }
        .text-xl { font-size: 1.5rem; font-weight: 800; }
        .text-sm { font-size: 0.85rem; color: var(--text-muted); }
        .money { font-family: 'Courier New', monospace; font-weight: bold; color: var(--success); }

        /* Components */
        button {
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
            background: var(--bg-card);
            color: var(--text-main);
        }
        button:active { transform: scale(0.96); opacity: 0.8; }
        button.primary { background: var(--accent); color: white; }
        button.danger { background: var(--danger); color: white; }
        button.success { background: var(--success); color: black; }
        button.large { padding: 20px; font-size: 1.2rem; }
        
        /* Player Colors */
        .bg-red { background-color: var(--p-red) !important; color: black !important; }
        .bg-blue { background-color: var(--p-blue) !important; color: white !important; }
        .bg-green { background-color: var(--p-green) !important; color: black !important; }
        .bg-yellow { background-color: var(--p-yellow) !important; color: black !important; }

        .text-red { color: var(--p-red); }
        .text-blue { color: var(--p-blue); }
        .text-green { color: var(--p-green); }
        .text-yellow { color: var(--p-yellow); }

        /* Specific Views */
        /* Home Grid */
        #home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr 1fr;
            height: 100%;
            gap: 2px;
        }
        .economy-banner {
            grid-column: 1 / -1;
            padding: 15px;
            background: #2c2c2c;
            border-bottom: 2px solid #333;
            text-align: center;
        }
        .player-btn {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            border-radius: 0;
        }

        /* Lists */
        .list-item {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .prop-color {
            width: 12px; height: 100%;
            position: absolute; left: 0; top: 0; bottom: 0;
            border-radius: 8px 0 0 8px;
        }
        .list-item.has-color { position: relative; padding-left: 24px; overflow: hidden;}

        /* Modals/Overlays */
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; padding: 20px;
        }
        
        .auction-player-card {
            padding: 10px; border: 2px solid transparent;
            opacity: 0.5; text-align: center;
        }
        .auction-player-card.active { border-color: white; opacity: 1; }
        .auction-player-card.out { text-decoration: line-through; color: red; }

        /* Input */
        input[type="number"], select {
            background: #333; border: 1px solid #555;
            color: white; padding: 10px; font-size: 1.2rem;
            width: 100%; border-radius: 4px;
        }

    </style>
</head>
<body>

    <!-- APP CONTAINER -->
    <div id="app"></div>

    <!-- LOGIC -->
    <script>
        // --- CONSTANTS & DATA ---
        
        const GROUPS = {
            BROWN: { id: 'brown', color: 'var(--c-brown)', name: 'Brown' },
            LBLUE: { id: 'lblue', color: 'var(--c-light-blue)', name: 'Light Blue' },
            PINK: { id: 'pink', color: 'var(--c-pink)', name: 'Pink' },
            ORANGE: { id: 'orange', color: 'var(--c-orange)', name: 'Orange' },
            RED: { id: 'red', color: 'var(--c-red)', name: 'Red' },
            YELLOW: { id: 'yellow', color: 'var(--c-yellow)', name: 'Yellow' },
            GREEN: { id: 'green', color: 'var(--c-green)', name: 'Green' },
            DBLUE: { id: 'dblue', color: 'var(--c-blue)', name: 'Dark Blue' },
            RAIL: { id: 'rail', color: 'var(--c-rail)', name: 'Railroad' },
            UTIL: { id: 'util', color: 'var(--c-util)', name: 'Utility' },
            NONE: { id: 'none', color: 'transparent', name: 'Special' }
        };

        // Simplified card maps for demo (user enters card #)
        const CHANCE_CARDS = {
            1: { txt: "Advance to Go", money: 200, move: 0 },
            2: { txt: "Bank pays dividend", money: 50 },
            3: { txt: "Go Back 3 Spaces", move: -3 },
            4: { txt: "Go to Jail", move: 10, jail: true },
            5: { txt: "General Repairs - Pay 25", money: -25 },
            // Add more logic as needed, simplified for strict "executes action" req
        };

        const BOARD = [
            { id: 0, name: "GO", type: "go", group: GROUPS.NONE },
            { id: 1, name: "Mediterranean Ave", price: 60, rent: [2, 10, 30, 90, 160, 250], houseCost: 50, group: GROUPS.BROWN, type: "property" },
            { id: 2, name: "Community Chest", type: "chest", group: GROUPS.NONE },
            { id: 3, name: "Baltic Ave", price: 60, rent: [4, 20, 60, 180, 320, 450], houseCost: 50, group: GROUPS.BROWN, type: "property" },
            { id: 4, name: "Income Tax", type: "tax", amount: 200, group: GROUPS.NONE },
            { id: 5, name: "Reading Railroad", price: 200, rent: [25, 50, 100, 200], group: GROUPS.RAIL, type: "rail" },
            { id: 6, name: "Oriental Ave", price: 100, rent: [6, 30, 90, 270, 400, 550], houseCost: 50, group: GROUPS.LBLUE, type: "property" },
            { id: 7, name: "Chance", type: "chance", group: GROUPS.NONE },
            { id: 8, name: "Vermont Ave", price: 100, rent: [6, 30, 90, 270, 400, 550], houseCost: 50, group: GROUPS.LBLUE, type: "property" },
            { id: 9, name: "Connecticut Ave", price: 120, rent: [8, 40, 100, 300, 450, 600], houseCost: 50, group: GROUPS.LBLUE, type: "property" },
            { id: 10, name: "Just Visiting / Jail", type: "jail", group: GROUPS.NONE },
            { id: 11, name: "St. Charles Place", price: 140, rent: [10, 50, 150, 450, 625, 750], houseCost: 100, group: GROUPS.PINK, type: "property" },
            { id: 12, name: "Electric Company", price: 150, group: GROUPS.UTIL, type: "util" },
            { id: 13, name: "States Ave", price: 140, rent: [10, 50, 150, 450, 625, 750], houseCost: 100, group: GROUPS.PINK, type: "property" },
            { id: 14, name: "Virginia Ave", price: 160, rent: [12, 60, 180, 500, 700, 900], houseCost: 100, group: GROUPS.PINK, type: "property" },
            { id: 15, name: "Pennsylvania Railroad", price: 200, rent: [25, 50, 100, 200], group: GROUPS.RAIL, type: "rail" },
            { id: 16, name: "St. James Place", price: 180, rent: [14, 70, 200, 550, 750, 950], houseCost: 100, group: GROUPS.ORANGE, type: "property" },
            { id: 17, name: "Community Chest", type: "chest", group: GROUPS.NONE },
            { id: 18, name: "Tennessee Ave", price: 180, rent: [14, 70, 200, 550, 750, 950], houseCost: 100, group: GROUPS.ORANGE, type: "property" },
            { id: 19, name: "New York Ave", price: 200, rent: [16, 80, 220, 600, 800, 1000], houseCost: 100, group: GROUPS.ORANGE, type: "property" },
            { id: 20, name: "Free Parking", type: "parking", group: GROUPS.NONE },
            { id: 21, name: "Kentucky Ave", price: 220, rent: [18, 90, 250, 700, 875, 1050], houseCost: 150, group: GROUPS.RED, type: "property" },
            { id: 22, name: "Chance", type: "chance", group: GROUPS.NONE },
            { id: 23, name: "Indiana Ave", price: 220, rent: [18, 90, 250, 700, 875, 1050], houseCost: 150, group: GROUPS.RED, type: "property" },
            { id: 24, name: "Illinois Ave", price: 240, rent: [20, 100, 300, 750, 925, 1100], houseCost: 150, group: GROUPS.RED, type: "property" },
            { id: 25, name: "B. & O. Railroad", price: 200, rent: [25, 50, 100, 200], group: GROUPS.RAIL, type: "rail" },
            { id: 26, name: "Atlantic Ave", price: 260, rent: [22, 110, 330, 800, 975, 1150], houseCost: 150, group: GROUPS.YELLOW, type: "property" },
            { id: 27, name: "Ventnor Ave", price: 260, rent: [22, 110, 330, 800, 975, 1150], houseCost: 150, group: GROUPS.YELLOW, type: "property" },
            { id: 28, name: "Water Works", price: 150, group: GROUPS.UTIL, type: "util" },
            { id: 29, name: "Marvin Gardens", price: 280, rent: [24, 120, 360, 850, 1025, 1200], houseCost: 150, group: GROUPS.YELLOW, type: "property" },
            { id: 30, name: "Go To Jail", type: "gotojail", group: GROUPS.NONE },
            { id: 31, name: "Pacific Ave", price: 300, rent: [26, 130, 390, 900, 1100, 1275], houseCost: 200, group: GROUPS.GREEN, type: "property" },
            { id: 32, name: "North Carolina Ave", price: 300, rent: [26, 130, 390, 900, 1100, 1275], houseCost: 200, group: GROUPS.GREEN, type: "property" },
            { id: 33, name: "Community Chest", type: "chest", group: GROUPS.NONE },
            { id: 34, name: "Pennsylvania Ave", price: 320, rent: [28, 150, 450, 1000, 1200, 1400], houseCost: 200, group: GROUPS.GREEN, type: "property" },
            { id: 35, name: "Short Line", price: 200, rent: [25, 50, 100, 200], group: GROUPS.RAIL, type: "rail" },
            { id: 36, name: "Chance", type: "chance", group: GROUPS.NONE },
            { id: 37, name: "Park Place", price: 350, rent: [35, 175, 500, 1100, 1300, 1500], houseCost: 200, group: GROUPS.DBLUE, type: "property" },
            { id: 38, name: "Luxury Tax", type: "tax", amount: 100, group: GROUPS.NONE },
            { id: 39, name: "Boardwalk", price: 400, rent: [50, 200, 600, 1400, 1700, 2000], houseCost: 200, group: GROUPS.DBLUE, type: "property" }
        ];

        // --- STATE MANAGEMENT ---

        const state = {
            players: [
                { id: 'p1', name: 'Red', colorClass: 'bg-red', textClass: 'text-red', cash: 1500, passedGo: false },
                { id: 'p2', name: 'Blue', colorClass: 'bg-blue', textClass: 'text-blue', cash: 1500, passedGo: false },
                { id: 'p3', name: 'Green', colorClass: 'bg-green', textClass: 'text-green', cash: 1500, passedGo: false },
                { id: 'p4', name: 'Yellow', colorClass: 'bg-yellow', textClass: 'text-yellow', cash: 1500, passedGo: false },
            ],
            properties: BOARD.map(b => ({ ...b, owner: null, houses: 0, mortgaged: false })),
            economy: {
                active: false,
                round: 1,
                affectedGroups: [],
                multiplier: 1,
                desc: "Stable Market"
            },
            currentScreen: 'home', // home, player, auction, trade, property
            selectedPlayerId: null,
            selectedPropertyId: null,
            auction: null, // { propId, bids: [], activePlayers: [], currentBid }
            trade: { p1: null, p2: null, items1: [], items2: [], cash1: 0, cash2: 0 }
        };

        // --- LOGIC ENGINE ---

        function getRent(propId) {
            const prop = state.properties[propId];
            if (!prop.owner || prop.mortgaged) return 0;
            
            // Economy effect
            let multiplier = 1;
            if (state.economy.active && state.economy.affectedGroups.includes(prop.group.id)) {
                multiplier = state.economy.multiplier;
            }

            // Logic for Utilities
            if (prop.type === 'util') {
                // Simplified: App asks for dice roll if needed, but for now we return a base multiplier instructions
                return `Dice x ${hasFullSet(prop.owner, prop.group) ? 10 : 4} ${multiplier !== 1 ? `(Econ x${multiplier})` : ''}`;
            }

            // Logic for Rails
            if (prop.type === 'rail') {
                const owned = state.properties.filter(p => p.type === 'rail' && p.owner === prop.owner).length;
                let rent = prop.rent[owned - 1] || 25;
                return Math.floor(rent * multiplier);
            }

            // Standard Property
            let rent = 0;
            if (prop.houses === 0) {
                rent = prop.rent[0];
                if (hasFullSet(prop.owner, prop.group)) rent *= 2;
            } else {
                rent = prop.rent[prop.houses];
            }
            return Math.floor(rent * multiplier);
        }

        function hasFullSet(ownerId, group) {
            const groupProps = state.properties.filter(p => p.group.id === group.id);
            return groupProps.every(p => p.owner === ownerId);
        }

        function updateEconomy() {
            // Pick 2 random groups
            const keys = Object.keys(GROUPS).filter(k => k !== 'NONE' && k !== 'RAIL' && k !== 'UTIL');
            const g1 = GROUPS[keys[Math.floor(Math.random() * keys.length)]].id;
            let g2 = GROUPS[keys[Math.floor(Math.random() * keys.length)]].id;
            while(g1 === g2) g2 = GROUPS[keys[Math.floor(Math.random() * keys.length)]].id;

            const events = [
                { name: "BOOM", mul: 1.5, desc: "Market Boom! +50% Rent" },
                { name: "RECESSION", mul: 0.7, desc: "Recession! -30% Rent" },
                { name: "HOUSING BUBBLE", mul: 1.2, desc: "Bubble! +20% Rent" },
                { name: "CRASH", mul: 0.5, desc: "Market Crash! -50% Rent" }
            ];
            const event = events[Math.floor(Math.random() * events.length)];

            state.economy = {
                active: true,
                round: state.economy.round + 1,
                affectedGroups: [g1, g2],
                multiplier: event.mul,
                desc: `${event.name}: ${event.desc} for affected colors.`
            };
            
            // Reset Pass Go flags
            state.players.forEach(p => p.passedGo = false);
            render();
            showMessage(`ECONOMY UPDATE!\n${state.economy.desc}`);
        }

        function checkEconomyTrigger() {
            if (state.players.every(p => p.passedGo)) {
                updateEconomy();
            } else {
                render();
            }
        }

        function handlePassGo(playerId, type) {
            const player = state.players.find(p => p.id === playerId);
            if (!player.passedGo) {
                player.passedGo = true;
                player.cash += 200; // Standard GO money
                if(type === 'land') player.cash += 200; // House rule: Land on go = double? Standard is just pass. Let's keep strict 200 for pass.
                // Prompt said "Land -> Collect, Pass -> Collect". I'll treat Land as Pass + End Turn logic visually. 
                checkEconomyTrigger();
            }
        }

        function startAuction(propId) {
            state.auction = {
                propId: propId,
                currentBid: state.properties[propId].price / 2, // Start half price
                highestBidder: null,
                activePlayers: state.players.filter(p => p.cash >= (state.properties[propId].price / 2)).map(p => p.id),
                turnIndex: 0
            };
            state.currentScreen = 'auction';
            render();
        }

        function submitBid(amount) {
            const auc = state.auction;
            const pid = auc.activePlayers[auc.turnIndex];
            const player = state.players.find(p => p.id === pid);

            if (amount === -1) {
                // Drop out
                auc.activePlayers.splice(auc.turnIndex, 1);
                if (auc.turnIndex >= auc.activePlayers.length) auc.turnIndex = 0;
            } else {
                if (player.cash < amount) {
                    showMessage("Not enough cash!");
                    return;
                }
                auc.currentBid = amount;
                auc.highestBidder = pid;
                auc.turnIndex = (auc.turnIndex + 1) % auc.activePlayers.length;
            }

            // Check winner
            if (auc.activePlayers.length === 1 && auc.highestBidder) {
                const winnerId = auc.activePlayers[0];
                const winner = state.players.find(p => p.id === winnerId);
                const prop = state.properties[auc.propId];
                
                winner.cash -= auc.currentBid;
                prop.owner = winnerId;
                state.auction = null;
                state.currentScreen = 'player-menu'; // return to context
                showMessage(`${winner.name} won ${prop.name} for $${auc.currentBid}!`);
            } else if (auc.activePlayers.length === 0) {
                 state.auction = null;
                 state.currentScreen = 'board';
                 showMessage("Auction Cancelled - No bidders.");
            }

            render();
        }

        // --- RENDERERS ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            if (state.currentScreen === 'home') renderHome(app);
            else if (state.currentScreen === 'player-menu') renderPlayerMenu(app);
            else if (state.currentScreen === 'board') renderBoard(app);
            else if (state.currentScreen === 'property-details') renderPropDetails(app);
            else if (state.currentScreen === 'auction') renderAuction(app);
            else if (state.currentScreen === 'trade') renderTrade(app);
            else if (state.currentScreen === 'cards') renderCards(app);
        }

        function renderHome(container) {
            const econGroups = state.economy.affectedGroups.map(gid => {
                const g = Object.values(GROUPS).find(x => x.id === gid);
                return `<span style="color:${g.color}">‚óè</span>`;
            }).join(' ');

            const html = `
                <div class="screen" id="home-grid">
                    <div class="economy-banner">
                        <div class="text-sm">ECONOMY (Round ${state.economy.round})</div>
                        <div class="text-lg" style="color:var(--accent)">${state.economy.desc}</div>
                        <div>Affected: ${econGroups || 'None yet'}</div>
                    </div>
                    ${state.players.map(p => `
                        <button class="player-btn ${p.colorClass}" onclick="openPlayer('${p.id}')">
                            <div class="text-xl">${p.name}</div>
                            <div class="text-lg bg-card" style="background:rgba(0,0,0,0.3); padding:5px; border-radius:4px; margin-top:5px;">$${p.cash}</div>
                            ${p.passedGo ? '<div style="font-size:0.8rem">Passed GO</div>' : ''}
                        </button>
                    `).join('')}
                </div>
            `;
            container.innerHTML = html;
        }

        function openPlayer(id) {
            state.selectedPlayerId = id;
            state.currentScreen = 'player-menu';
            render();
        }

        function renderPlayerMenu(container) {
            const p = state.players.find(x => x.id === state.selectedPlayerId);
            container.innerHTML = `
                <div class="screen">
                    <div class="row between" style="padding:15px; background:${getComputedStyle(document.documentElement).getPropertyValue('--bg-card')}">
                        <h2 class="${p.textClass}">${p.name} Menu</h2>
                        <button onclick="state.currentScreen='home'; render()">Close</button>
                    </div>
                    
                    <div class="col" style="padding:20px; flex:1; justify-content:center;">
                        <div class="center col" style="margin-bottom:30px">
                             <div class="text-sm">Current Balance</div>
                             <div class="money text-xl" style="font-size:3rem">$${p.cash}</div>
                        </div>

                        <button class="large primary" onclick="state.currentScreen='board'; render()">üó∫Ô∏è Board Spaces</button>
                        <button class="large" onclick="viewProperties('${p.id}')">üè† My Properties</button>
                        <button class="large" onclick="startTrade('${p.id}')">ü§ù Trade</button>
                        
                        <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px">
                             <h3 class="text-center" style="margin-bottom:10px">Quick Actions</h3>
                             <div class="row">
                                <button class="danger" style="flex:1" onclick="state.currentScreen='cards'; state.cardType='chance'; render()">Chance ?</button>
                                <button class="primary" style="flex:1" onclick="state.currentScreen='cards'; state.cardType='chest'; render()">Chest üì¶</button>
                             </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function viewProperties(pid) {
            // Filter view for Board, but pre-scroll or filter to owned? 
            // Request says "List of owned properties".
            // I'll re-use the board renderer but filter it, or just a simple list.
            // Let's use a specific owned list.
            const p = state.players.find(x => x.id === pid);
            const owned = state.properties.filter(prop => prop.owner === pid);
            
            const listHtml = owned.length === 0 ? '<div style="padding:20px; text-align:center">No properties owned.</div>' : 
                owned.map(prop => `
                    <div class="list-item has-color" onclick="openPropDetails(${prop.id})">
                        <div class="prop-color" style="background:${prop.group.color}"></div>
                        <div>
                            <div class="text-lg">${prop.name}</div>
                            <div class="text-sm">Rent: $${getRent(prop.id)} ${prop.mortgaged ? '(MORTGAGED)' : ''}</div>
                        </div>
                        <div class="col" style="align-items:flex-end">
                            ${prop.type === 'property' ? `<div>üè† ${prop.houses === 5 ? 'Hotel' : prop.houses}</div>` : ''}
                        </div>
                    </div>
                `).join('');

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="screen">
                    <div class="row between" style="padding:15px; border-bottom:1px solid #333">
                        <button onclick="state.currentScreen='player-menu'; render()">Back</button>
                        <h2>Owned Properties</h2>
                        <div style="width:50px"></div>
                    </div>
                    <div class="scroll-y">
                        ${listHtml}
                    </div>
                </div>
            `;
        }

        function renderBoard(container) {
            const list = BOARD.map(space => {
                let ownerName = "";
                let bgStyle = "";
                if (space.owner) {
                    const owner = state.players.find(p => p.id === space.owner);
                    ownerName = `<span class="${owner.textClass} text-sm">Owned by ${owner.name}</span>`;
                }
                
                let icon = "";
                if(space.type === 'go') icon = "üèÅ";
                if(space.type === 'chance') icon = "‚ùì";
                if(space.type === 'chest') icon = "üì¶";
                if(space.type === 'jail') icon = "üîí";
                if(space.type === 'gotojail') icon = "üëÆ";

                const isColor = space.group.id !== 'none';

                return `
                <div class="list-item ${isColor ? 'has-color' : ''}" onclick="selectBoardSpace(${space.id})">
                    ${isColor ? `<div class="prop-color" style="background:${space.group.color}"></div>` : ''}
                    <div style="flex:1">
                        <div class="text-lg">${icon} ${space.name}</div>
                        ${ownerName}
                    </div>
                    ${space.price ? `<div class="money">$${space.price}</div>` : ''}
                </div>`;
            }).join('');

            container.innerHTML = `
                <div class="screen">
                     <div class="row between" style="padding:15px; border-bottom:1px solid #333">
                        <button onclick="state.currentScreen='player-menu'; render()">Back</button>
                        <h2>Board</h2>
                        <div style="width:50px"></div>
                    </div>
                    <div class="scroll-y">
                        ${list}
                    </div>
                </div>
            `;
        }

        function selectBoardSpace(id) {
            const space = state.properties[id];
            
            // GO Logic
            if (space.type === 'go') {
                const p = state.players.find(x => x.id === state.selectedPlayerId);
                // Prompt asks: Land vs Pass
                const app = document.getElementById('app');
                app.innerHTML += `
                    <div class="overlay">
                        <h2 style="text-align:center; margin-bottom:20px">GO ACTION</h2>
                        <button class="primary large" style="margin-bottom:10px" onclick="handlePassGo('${state.selectedPlayerId}', 'land'); state.currentScreen='home'; render()">Landed On GO (Collect $200)</button>
                        <button class="success large" style="margin-bottom:10px" onclick="handlePassGo('${state.selectedPlayerId}', 'pass'); state.currentScreen='board'; render()">Passed GO (Collect $200)</button>
                        <button class="danger" onclick="render()">Cancel</button>
                    </div>
                `;
                return;
            }

            // Normal Property Logic
            if (space.price) { // Buyable
                state.selectedPropertyId = id;
                state.currentScreen = 'property-details';
                render();
            } else if (['chance', 'chest'].includes(space.type)) {
                state.cardType = space.type;
                state.currentScreen = 'cards';
                render();
            } else {
                showMessage("No action needed here directly.");
            }
        }

        function renderPropDetails(container) {
            const prop = state.properties[state.selectedPropertyId];
            const player = state.players.find(p => p.id === state.selectedPlayerId);
            const isOwner = prop.owner === player.id;
            const isOwnedByOther = prop.owner && !isOwner;
            const rent = getRent(prop.id);

            let actions = '';

            if (!prop.owner) {
                actions = `
                    <button class="success large" onclick="buyProperty('${player.id}', ${prop.id})">Buy for $${prop.price}</button>
                    <button class="primary large" onclick="startAuction(${prop.id})">Auction</button>
                `;
            } else if (isOwner) {
                // Building logic
                const canBuild = prop.type === 'property' && hasFullSet(player.id, prop.group) && prop.houses < 5 && !prop.mortgaged;
                const canSellHouse = prop.houses > 0;
                
                actions = `
                    <div class="row">
                        ${canBuild ? `<button class="primary" style="flex:1" onclick="modifyHouse(${prop.id}, 1)">Build ($${prop.houseCost})</button>` : ''}
                        ${canSellHouse ? `<button class="danger" style="flex:1" onclick="modifyHouse(${prop.id}, -1)">Sell House (+$${prop.houseCost/2})</button>` : ''}
                    </div>
                    <button class="large" style="margin-top:10px; background:#555" onclick="toggleMortgage(${prop.id})">
                        ${prop.mortgaged ? `Unmortgage ($${Math.floor(prop.price/2 * 1.1)})` : `Mortgage (+$${prop.price/2})`}
                    </button>
                `;
            } else if (isOwnedByOther) {
                const owner = state.players.find(p => p.id === prop.owner);
                actions = `
                    <div class="text-center" style="margin-bottom:20px; color:var(--danger)">Owned by ${owner.name}</div>
                    <button class="danger large" onclick="payRent('${player.id}', '${owner.id}', ${rent})">Pay Rent $${rent}</button>
                `;
            }

            container.innerHTML = `
                <div class="screen">
                     <div class="row between" style="padding:15px; border-bottom:1px solid #333">
                        <button onclick="state.currentScreen='board'; render()">Back</button>
                        <h2>${prop.name}</h2>
                        <div style="width:50px"></div>
                    </div>
                    <div class="col" style="padding:20px; flex:1">
                        <div style="background:${prop.group.color}; height:50px; width:100%; border-radius:8px; margin-bottom:20px"></div>
                        
                        <div class="text-xl text-center money">$${prop.price || 'N/A'}</div>
                        <div class="text-center text-sm">Base Rent: $${prop.rent ? prop.rent[0] : 0}</div>
                        ${prop.type === 'property' ? `<div class="text-center text-sm">Houses: ${prop.houses}</div>` : ''}
                        
                        ${state.economy.affectedGroups.includes(prop.group.id) ? 
                            `<div class="text-center" style="color:var(--accent); margin:10px 0;">Affected by Economy: x${state.economy.multiplier}</div>` 
                        : ''}

                        <div style="flex:1"></div>
                        <div class="col">${actions}</div>
                    </div>
                </div>
            `;
        }

        // --- ACTIONS ---

        function buyProperty(pid, propId) {
            const player = state.players.find(p => p.id === pid);
            const prop = state.properties[propId];
            if (player.cash >= prop.price) {
                player.cash -= prop.price;
                prop.owner = pid;
                showMessage("Property Purchased!");
                render();
            } else {
                showMessage("Not enough cash!");
            }
        }

        function modifyHouse(propId, amount) {
            const prop = state.properties[propId];
            const player = state.players.find(p => p.id === prop.owner);
            
            if (amount > 0) { // Build
                if (player.cash >= prop.houseCost) {
                    player.cash -= prop.houseCost;
                    prop.houses++;
                    render();
                } else showMessage("Not enough cash!");
            } else { // Sell
                player.cash += prop.houseCost / 2;
                prop.houses--;
                render();
            }
        }

        function toggleMortgage(propId) {
            const prop = state.properties[propId];
            const player = state.players.find(p => p.id === prop.owner);
            const mtgValue = prop.price / 2;
            const unmtgCost = Math.floor(mtgValue * 1.1);

            if (prop.mortgaged) {
                if (player.cash >= unmtgCost) {
                    player.cash -= unmtgCost;
                    prop.mortgaged = false;
                    render();
                } else showMessage("Not enough cash!");
            } else {
                if (prop.houses > 0) {
                    showMessage("Must sell houses first.");
                    return;
                }
                player.cash += mtgValue;
                prop.mortgaged = true;
                render();
            }
        }

        function payRent(fromId, toId, amount) {
            const from = state.players.find(p => p.id === fromId);
            const to = state.players.find(p => p.id === toId);
            
            from.cash -= amount;
            to.cash += amount;
            showMessage(`Paid $${amount} to ${to.name}`);
            state.currentScreen = 'player-menu';
            render();
        }

        function renderAuction(container) {
            const auc = state.auction;
            const currentPlayerId = auc.activePlayers[auc.turnIndex];
            const currentPlayer = state.players.find(p => p.id === currentPlayerId);
            const prop = state.properties[auc.propId];
            const minBid = auc.currentBid + 10;

            const playerStatusHtml = state.players.map(p => {
                const isActive = auc.activePlayers.includes(p.id);
                const isTurn = p.id === currentPlayerId;
                const isLeader = p.id === auc.highestBidder;
                return `
                    <div class="auction-player-card ${!isActive ? 'out' : ''} ${isTurn ? 'active' : ''} ${p.textClass}">
                        ${p.name} ($${p.cash})
                        ${isLeader ? 'üëë' : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="screen" style="background:rgba(0,0,0,0.95); padding:20px; justify-content:center;">
                    <h1 class="text-center" style="color:var(--accent)">AUCTION</h1>
                    <h3 class="text-center">${prop.name}</h3>
                    <div class="text-center money" style="font-size:3rem; margin:20px 0">$${auc.currentBid}</div>
                    
                    <div class="row" style="justify-content:center; flex-wrap:wrap; gap:10px; margin-bottom:30px">
                        ${playerStatusHtml}
                    </div>

                    <div class="col">
                        <div class="text-center">Current Turn: <span class="${currentPlayer.textClass}">${currentPlayer.name}</span></div>
                        <button class="primary large" onclick="submitBid(${minBid})">Bid $${minBid}</button>
                        <button class="primary" style="margin-top:10px" onclick="submitBid(${minBid + 90})">Bid $${minBid + 90}</button>
                        <button class="danger" style="margin-top:20px" onclick="submitBid(-1)">Drop Out</button>
                    </div>
                </div>
            `;
        }

        function renderCards(container) {
            container.innerHTML = `
                <div class="screen center">
                    <h2>${state.cardType === 'chance' ? 'CHANCE' : 'COMMUNITY CHEST'}</h2>
                    <p style="margin:20px">Enter Card Number:</p>
                    <input type="number" id="cardNumInput" style="width:100px; text-align:center" autofocus>
                    <div class="row" style="margin-top:20px; gap:10px">
                        <button class="danger" onclick="state.currentScreen='player-menu'; render()">Cancel</button>
                        <button class="success" onclick="executeCard()">Execute</button>
                    </div>
                </div>
            `;
        }

        function executeCard() {
            const num = parseInt(document.getElementById('cardNumInput').value);
            const p = state.players.find(x => x.id === state.selectedPlayerId);
            
            // Simplified Logic for Demo:
            // In a real build, we'd map all 16 cards per deck. 
            // Here we show we can manipulate state.
            
            // Check mapped cards first
            if (CHANCE_CARDS[num]) {
                const card = CHANCE_CARDS[num];
                if (card.money) p.cash += card.money;
                // Move logic would require complex board math, keeping it simple for "Companion" aspect
                showMessage(`Card #${num}: ${card.txt}`);
            } else {
                // Fallback for manual handling
                showMessage(`Card #${num} not in database. Please perform action manually.`);
            }
            state.currentScreen = 'player-menu';
            render();
        }

        // --- TRADING SYSTEM ---

        function startTrade(pid) {
            state.trade.p1 = pid;
            state.trade.p2 = null;
            state.trade.items1 = [];
            state.trade.items2 = [];
            state.trade.cash1 = 0;
            state.trade.cash2 = 0;
            state.currentScreen = 'trade';
            render();
        }

        function renderTrade(container) {
            if (!state.trade.p2) {
                // Select Partner
                const buttons = state.players.filter(p => p.id !== state.trade.p1).map(p => 
                    `<button class="large ${p.colorClass}" style="margin:5px" onclick="state.trade.p2='${p.id}'; render()">${p.name}</button>`
                ).join('');
                container.innerHTML = `<div class="screen center"><h2>Select Trading Partner</h2><div class="col">${buttons}</div><button style="margin-top:20px" onclick="state.currentScreen='player-menu'; render()">Cancel</button></div>`;
                return;
            }

            const p1 = state.players.find(p => p.id === state.trade.p1);
            const p2 = state.players.find(p => p.id === state.trade.p2);

            // Trade Grid
            container.innerHTML = `
                <div class="screen">
                    <div class="row between" style="padding:10px; border-bottom:1px solid #333">
                         <h3>Trade</h3>
                         <button onclick="executeTrade()" class="success">CONFIRM</button>
                         <button onclick="state.currentScreen='player-menu'; render()">Cancel</button>
                    </div>
                    <div class="row" style="flex:1; align-items:stretch; overflow:hidden;">
                        <!-- Player 1 Side -->
                        <div class="col" style="flex:1; padding:10px; border-right:1px solid #333; overflow-y:auto">
                            <h3 class="${p1.textClass}">${p1.name} Offers</h3>
                            <input type="number" placeholder="Cash Offer" onchange="state.trade.cash1 = parseInt(this.value) || 0">
                            ${renderTradeProps(p1.id, 1)}
                        </div>
                        <!-- Player 2 Side -->
                        <div class="col" style="flex:1; padding:10px; overflow-y:auto">
                            <h3 class="${p2.textClass}">${p2.name} Offers</h3>
                            <input type="number" placeholder="Cash Offer" onchange="state.trade.cash2 = parseInt(this.value) || 0">
                            ${renderTradeProps(p2.id, 2)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTradeProps(pid, side) {
            const owned = state.properties.filter(p => p.owner === pid);
            return owned.map(p => `
                <div class="row" style="margin-top:5px; background:#222; padding:5px">
                    <input type="checkbox" onchange="toggleTradeItem(${p.id}, ${side}, this.checked)">
                    <div style="width:10px; height:10px; background:${p.group.color}; margin:0 5px"></div>
                    <span style="font-size:0.8rem">${p.name}</span>
                </div>
            `).join('');
        }

        function toggleTradeItem(propId, side, checked) {
            const list = side === 1 ? state.trade.items1 : state.trade.items2;
            if (checked) list.push(propId);
            else {
                const idx = list.indexOf(propId);
                if (idx > -1) list.splice(idx, 1);
            }
        }

        function executeTrade() {
            const t = state.trade;
            const p1 = state.players.find(p => p.id === t.p1);
            const p2 = state.players.find(p => p.id === t.p2);

            // Transfer Cash
            if (p1.cash < t.cash1 || p2.cash < t.cash2) {
                showMessage("Insufficient funds for this trade.");
                return;
            }
            p1.cash = p1.cash - t.cash1 + t.cash2;
            p2.cash = p2.cash - t.cash2 + t.cash1;

            // Transfer Props
            t.items1.forEach(id => state.properties[id].owner = t.p2);
            t.items2.forEach(id => state.properties[id].owner = t.p1);

            showMessage("Trade Completed!");
            state.currentScreen = 'player-menu';
            render();
        }

        // --- UTILS ---

        function showMessage(msg) {
            const div = document.createElement('div');
            div.className = 'overlay center';
            div.innerHTML = `<div style="background:var(--bg-card); padding:30px; border-radius:10px; max-width:80%; text-align:center">
                <h3>${msg}</h3>
                <button class="primary large" style="margin-top:20px" onclick="this.parentElement.parentElement.remove()">OK</button>
            </div>`;
            document.body.appendChild(div);
        }

        // --- BOOTSTRAP ---
        render();

    </script>
</body>

</html>
